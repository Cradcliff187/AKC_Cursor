{% extends "base.html" %}
{% from "components/buttons.html" import action_button, button_group, dropdown_button %}
{% from "components/cards.html" import info_card, stats_card, list_card, activity_card %}
{% from "components/action_bar.html" import detail_action_bar %}
{% from "components/modals.html" import confirm_delete_modal, status_change_modal, form_modal %}

{% block title %}{{ project.name }} - Project Details{% endblock %}

{% block content %}
{{ detail_action_bar(
    title=project.name,
    subtitle=project.client.name,
    status=project.status,
    status_class=project_status_classes[project.status],
    primary_actions=[
        action_button("Edit", href=url_for('edit_project', project_id=project.id), icon="edit", type="primary"),
        dropdown_button(
            text="Change Status",
            icon="exchange-alt",
            type="outline-primary",
            items=[
                {"text": status.title(), "icon": status_icons[status], "form_action": url_for('update_project_status', project_id=project.id), "form_data": {"status": status}}
                for status in allowed_status_transitions
            ]
        ),
        action_button("Delete", type="outline-danger", icon="trash", modal_target="deleteProjectModal")
    ]
) }}

<div class="row g-4">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Project Information -->
        {{ info_card(
            title="Project Information",
            items=[
                {"label": "Client", "value": project.client.name},
                {"label": "Manager", "value": project.manager.name},
                {"label": "Start Date", "value": project.start_date|date},
                {"label": "End Date", "value": project.end_date|date},
                {"label": "Budget", "value": "${:,.2f}".format(project.budget)},
                {"label": "Location", "value": project.location}
            ]
        ) }}

        <!-- Tasks -->
        {{ list_card(
            title="Tasks",
            items=[
                {
                    "title": task.title,
                    "subtitle": f"Due: {task.due_date|date}",
                    "actions": [
                        action_button("View", href=url_for('view_task', task_id=task.id), type="outline-primary", icon="eye")
                    ]
                }
                for task in project.tasks
            ],
            actions=[
                action_button("Add Task", icon="plus", type="outline-primary", modal_target="addTaskModal")
            ],
            empty_state='<p class="text-muted">No tasks created yet</p>'
        ) }}

        <!-- Recent Activity -->
        {{ activity_card(
            title="Recent Activity",
            activities=project.activities
        ) }}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Project Stats -->
        {{ stats_card(
            title="Project Metrics",
            stats=[
                {"label": "Tasks Completed", "value": f"{project.stats.completed_tasks}/{project.stats.total_tasks}", "icon": "tasks"},
                {"label": "Budget Used", "value": f"{project.stats.budget_used_percentage}%", "icon": "dollar-sign"},
                {"label": "Time Logged", "value": f"{project.stats.total_hours} hrs", "icon": "clock"},
                {"label": "Documents", "value": project.stats.document_count, "icon": "file"}
            ]
        ) }}

        <!-- Team Members -->
        {{ list_card(
            title="Team Members",
            items=[
                {
                    "title": member.name,
                    "subtitle": member.role,
                    "actions": [
                        action_button("Remove", type="outline-danger", icon="user-minus", 
                            data_attrs={"bs-toggle": "modal", "bs-target": "#removeTeamMemberModal", "member-id": member.id})
                    ]
                }
                for member in project.team_members
            ],
            actions=[
                action_button("Add Member", icon="user-plus", type="outline-primary", modal_target="addTeamMemberModal")
            ],
            empty_state='<p class="text-muted">No team members assigned</p>'
        ) }}

        <!-- Recent Documents -->
        {{ list_card(
            title="Recent Documents",
            items=[
                {
                    "title": doc.name,
                    "subtitle": doc.uploaded_at|date,
                    "actions": [
                        action_button("View", href=url_for('view_document', document_id=doc.id), type="outline-primary", icon="eye")
                    ]
                }
                for doc in project.recent_documents
            ],
            actions=[
                action_button("Upload", icon="upload", type="outline-primary", modal_target="uploadDocumentModal")
            ],
            empty_state='<p class="text-muted">No documents uploaded</p>'
        ) }}
    </div>
</div>

<!-- Modals -->
{{ confirm_delete_modal(
    id="deleteProjectModal",
    item_name=project.name,
    form_action=url_for('delete_project', project_id=project.id)
) }}

{% for status, message in status_messages.items() %}
{{ status_change_modal(
    id="status" + status + "Modal",
    title="Change Status to " + status.title(),
    message=message,
    form_action=url_for('update_project_status', project_id=project.id),
    new_status=status,
    button_style=status_styles[status],
    button_text="Change to " + status.title()
) }}
{% endfor %}

{{ form_modal(
    id="addTaskModal",
    title="Add Task",
    content=add_task_form,
    submit_text="Add Task",
    form_action=url_for('add_project_task', project_id=project.id)
) }}

{{ form_modal(
    id="addTeamMemberModal",
    title="Add Team Member",
    content=add_team_member_form,
    submit_text="Add Member",
    form_action=url_for('add_team_member', project_id=project.id)
) }}
{% endblock %} 