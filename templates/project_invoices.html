{% extends "base.html" %}

{% block title %}{{ project.name }} - Invoices{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Project Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">{{ project.name }}</h1>
            <p class="text-muted">Project Invoices</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('invoices/new') }}?project_id={{ project.id }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>New Invoice
            </a>
            <a href="{{ url_for('projects/' + project.id|string) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Project
            </a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-1">Total Invoices</h6>
                    <h3 class="mb-0">{{ total_invoices }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-1">Total Amount</h6>
                    <h3 class="mb-0">${{ "%.2f"|format(total_amount) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-1">Paid Amount</h6>
                    <h3 class="mb-0 text-success">${{ "%.2f"|format(paid_amount) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-1">Pending Amount</h6>
                    <h3 class="mb-0 text-warning">${{ "%.2f"|format(pending_amount) }}</h3>
                    {% if overdue_amount > 0 %}
                    <small class="text-danger">Overdue: ${{ "%.2f"|format(overdue_amount) }}</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Project Budget Progress -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title mb-0">Budget Progress</h5>
                <span class="text-muted">{{ budget_percentage }}% of budget invoiced</span>
            </div>
            <div class="progress" style="height: 10px;">
                <div class="progress-bar {{ budget_progress_color }}" role="progressbar" style="width: {{ budget_percentage }}%;" aria-valuenow="{{ budget_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="d-flex justify-content-between mt-2">
                <span class="text-muted small">Invoiced: ${{ "%.2f"|format(total_amount) }}</span>
                <span class="text-muted small">Budget: ${{ "%.2f"|format(project.budget) }}</span>
            </div>
        </div>
    </div>

    <!-- Invoices Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Invoices</h5>
            <div class="d-flex">
                <div class="input-group me-2" style="width: 250px;">
                    <span class="input-group-text bg-light border-0"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control border-0 bg-light" placeholder="Search invoices..." id="searchInput">
                </div>
                <select class="form-select border-0 bg-light" style="width: 150px;" id="statusFilter">
                    <option value="">All Statuses</option>
                    {% for status in statuses %}
                    <option value="{{ status }}">{{ status }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="invoicesTable">
                <thead class="bg-light">
                    <tr>
                        <th>Invoice #</th>
                        <th>Date</th>
                        <th>Due Date</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if invoices %}
                        {% for invoice in invoices %}
                        <tr data-status="{{ invoice.status }}">
                            <td>
                                <a href="{{ url_for('invoices/' + invoice.id|string) }}" class="text-decoration-none fw-medium">
                                    {{ invoice.invoice_number }}
                                </a>
                            </td>
                            <td>{{ invoice.date }}</td>
                            <td>{{ invoice.due_date }}</td>
                            <td>${{ "%.2f"|format(invoice.amount) }}</td>
                            <td>
                                <span class="badge bg-{{ invoice.status_color }}">{{ invoice.status }}</span>
                            </td>
                            <td class="text-end">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-icon" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="{{ url_for('invoices/' + invoice.id|string) }}"><i class="fas fa-eye me-2"></i>View</a></li>
                                        <li><a class="dropdown-item" href="{{ url_for('invoices/' + invoice.id|string + '/edit') }}"><i class="fas fa-edit me-2"></i>Edit</a></li>
                                        {% if invoice.status == 'Pending' %}
                                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#markPaidModal{{ invoice.id }}"><i class="fas fa-check-circle me-2 text-success"></i>Mark as Paid</a></li>
                                        {% endif %}
                                        <li><a class="dropdown-item" href="{{ url_for('invoices/' + invoice.id|string + '/print') }}" target="_blank"><i class="fas fa-print me-2"></i>Print</a></li>
                                        <li><a class="dropdown-item" href="#"><i class="fas fa-envelope me-2"></i>Email</a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <div class="py-5">
                                    <i class="fas fa-file-invoice-dollar fa-3x text-muted mb-3"></i>
                                    <h5>No invoices found</h5>
                                    <p class="text-muted">Create your first invoice for this project</p>
                                    <a href="{{ url_for('invoices/new') }}?project_id={{ project.id }}" class="btn btn-primary">
                                        <i class="fas fa-plus me-2"></i>New Invoice
                                    </a>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Mark as Paid Modals -->
{% for invoice in invoices %}
{% if invoice.status == 'Pending' %}
<div class="modal fade" id="markPaidModal{{ invoice.id }}" tabindex="-1" aria-labelledby="markPaidModalLabel{{ invoice.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('invoices/' + invoice.id|string + '/mark-paid') }}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="markPaidModalLabel{{ invoice.id }}">Mark Invoice #{{ invoice.invoice_number }} as Paid</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="payment_date{{ invoice.id }}" class="form-label">Payment Date</label>
                        <input type="date" class="form-control" id="payment_date{{ invoice.id }}" name="payment_date" value="{{ now().strftime('%Y-%m-%d') }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="payment_method{{ invoice.id }}" class="form-label">Payment Method</label>
                        <select class="form-select" id="payment_method{{ invoice.id }}" name="payment_method" required>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Check">Check</option>
                            <option value="Cash">Cash</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="payment_reference{{ invoice.id }}" class="form-label">Reference Number (Optional)</label>
                        <input type="text" class="form-control" id="payment_reference{{ invoice.id }}" name="payment_reference" placeholder="Check #, Transaction ID, etc.">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Mark as Paid</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Search functionality
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const table = document.getElementById('invoicesTable');
        const rows = table.querySelectorAll('tbody tr');

        function filterTable() {
            const searchTerm = searchInput.value.toLowerCase();
            const statusTerm = statusFilter.value;

            rows.forEach(row => {
                const invoiceNumber = row.querySelector('td:first-child').textContent.toLowerCase();
                const rowStatus = row.getAttribute('data-status');
                const statusMatch = statusTerm === '' || rowStatus === statusTerm;
                const searchMatch = invoiceNumber.includes(searchTerm);

                if (statusMatch && searchMatch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        searchInput.addEventListener('input', filterTable);
        statusFilter.addEventListener('change', filterTable);
    });
</script>
{% endblock %} 