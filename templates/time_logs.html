{% extends "base.html" %}
{% from "components/navigation.html" import list_header %}
{% from "components/forms.html" import search_form, select_group %}
{% from "components/cards.html" import list_card %}
{% from "components/buttons.html" import action_button %}

{% block title %}Time Logs - AKC CRM{% endblock %}

{% block content %}
{{ list_header(
    title="Time Logs",
    subtitle="Track time spent on projects and tasks",
    action_button=action_button("Log Time", "plus", url_for('new_time_log'), "primary")
) }}

<!-- Filters -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        {{ search_form(
            placeholder="Search time logs...",
            value=search_query,
            filters="""
            <div class="row g-2">
                <div class="col-md-4">
                    """ + select_group(
                        "Project",
                        "project_id",
                        options=[{"value": "", "label": "All Projects"}] + [
                            {"value": id, "label": name}
                            for id, name in projects
                        ],
                        selected=project_filter|string if project_filter else "",
                        help_text="Filter by project"
                    ) + """
                </div>
                <div class="col-md-4">
                    """ + select_group(
                        "User",
                        "user_id",
                        options=[{"value": "", "label": "All Users"}] + [
                            {"value": id, "label": name}
                            for id, name in users
                        ],
                        selected=user_filter|string if user_filter else "",
                        help_text="Filter by user"
                    ) + """
                </div>
                <div class="col-md-4">
                    """ + select_group(
                        "Date Range",
                        "date_range",
                        options=[
                            {"value": "", "label": "All Time"},
                            {"value": "today", "label": "Today"},
                            {"value": "week", "label": "This Week"},
                            {"value": "month", "label": "This Month"},
                            {"value": "custom", "label": "Custom Range"}
                        ],
                        selected=date_range if date_range else "",
                        help_text="Filter by date range"
                    ) + """
                </div>
            </div>
            """
        ) }}
    </div>
</div>

<!-- Time Logs List -->
{{ list_card(
    title="Time Entries",
    items=[
        {
            "title": log.project_name,
            "subtitle": f"{log.hours} hours - {log.description}",
            "meta": [
                {"label": "User", "value": log.user_name},
                {"label": "Date", "value": log.date|date},
                {"label": "Task", "value": log.task_name}
            ],
            "actions": [
                action_button("Edit", href=url_for('edit_time_log', log_id=log.id), type="outline-primary", icon="edit"),
                action_button("Delete", type="outline-danger", icon="trash", modal_target=f"deleteTimeLog{log.id}Modal")
            ]
        }
        for log in time_logs
    ],
    empty_state='<p class="text-muted">No time logs found</p>'
) }}

<!-- Delete Modals -->
{% for log in time_logs %}
{{ confirm_delete_modal(
    id=f"deleteTimeLog{log.id}Modal",
    item_name=f"time log for {log.project_name}",
    form_action=url_for('delete_time_log', log_id=log.id)
) }}
{% endfor %}

<!-- Custom Date Range Modal -->
<div class="modal fade" id="customDateRangeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Date Range</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="dateRangeForm">
                    <div class="row">
                        <div class="col-md-6">
                            {{ form_group("Start Date", "start_date", type="date", required=true) }}
                        </div>
                        <div class="col-md-6">
                            {{ form_group("End Date", "end_date", type="date", required=true) }}
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="applyDateRange">Apply</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle date range selection
        const dateRangeSelect = document.getElementById('date_range');
        const customDateRangeModal = new bootstrap.Modal(document.getElementById('customDateRangeModal'));
        
        dateRangeSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customDateRangeModal.show();
            } else {
                document.getElementById('filterForm').submit();
            }
        });
        
        // Handle custom date range form submission
        document.getElementById('applyDateRange').addEventListener('click', function() {
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            
            if (startDate && endDate) {
                const form = document.getElementById('filterForm');
                const startInput = document.createElement('input');
                startInput.type = 'hidden';
                startInput.name = 'start_date';
                startInput.value = startDate;
                
                const endInput = document.createElement('input');
                endInput.type = 'hidden';
                endInput.name = 'end_date';
                endInput.value = endDate;
                
                form.appendChild(startInput);
                form.appendChild(endInput);
                form.submit();
            }
        });
    });
</script>
{% endblock %} 